<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .checkout-container {
      max-width: 520px;
      margin: 4rem auto 0 auto;
      background: #23272f;
      border-radius: 14px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.22);
      padding: 2.5rem 2rem 2rem 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #f1f1f1;
    }
    .checkout-container img {
      width: 100%;
      max-width: 220px;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      object-fit: cover;
      background: #181a1b;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
    }
    .checkout-container h2 {
      margin: 0 0 0.7rem 0;
      font-size: 2rem;
      color: #4f8cff;
      font-weight: 700;
      text-align: center;
    }
    .checkout-container .price {
      color: #4f8cff;
      font-size: 1.2rem;
      margin-bottom: 1.2rem;
      font-weight: 500;
    }
    .checkout-info-row {
      width: 100%;
      margin-bottom: 0.8rem;
      font-size: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .checkout-label {
      color: #b3b3b3;
      font-weight: 500;
      font-size: 1.22rem;
    }
    .spotify-link {
      color: #1db954;
      word-break: break-all;
      text-decoration: underline;
    }
    .back-btn {
      margin-top: 2rem;
      background: #23272f;
      color: #4f8cff;
      border: 2px solid #4f8cff;
      border-radius: 6px;
      padding: 0.6rem 1.3rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    .back-btn:hover {
      background: #4f8cff;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="checkout-container">
    <h2>Order Summary</h2>
    <div id="cart-items-summary" style="width:100%;background:#181a1b;border-radius:10px;padding:1.2rem 1.1rem;margin-bottom:1.2rem;box-shadow:0 2px 12px rgba(0,0,0,0.13);">
      <!-- Cart items will be populated here -->
    </div>
    <div style="width:100%;background:#181a1b;border-radius:10px;padding:1.2rem 1.1rem;margin-bottom:1.2rem;box-shadow:0 2px 12px rgba(0,0,0,0.13);display:flex;flex-direction:column;gap:0.7rem;">
      <div class="checkout-info-row" style="margin-bottom:0;">
        <span class="checkout-label">Subtotal:</span>
        <span id="checkout-subtotal" style="text-align:right;font-weight:600;font-size:1.22rem;"></span>
      </div>
      <div class="checkout-info-row" style="margin-bottom:0;">
        <span class="checkout-label">Shipping:</span>
        <span id="checkout-shipping" style="text-align:right;font-weight:600;font-size:1.22rem;"></span>
      </div>
      <div class="checkout-info-row" style="margin-bottom:0;border-top:2px solid #3a4048;padding-top:1rem;">
        <span class="checkout-label" style="color:#4f8cff;font-size:1.3rem;">Total:</span>
        <span id="checkout-total-price" style="text-align:right;font-weight:600;font-size:1.3rem;color:#4f8cff;"></span>
      </div>
    </div>
    <form id="checkout-form" style="width:100%;margin-top:2.2rem;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="display:flex;flex-direction:column;gap:0.4rem;">
        <label for="full-name" style="color:#f1f1f1;font-size:1.05rem;">Full Name:</label>
        <input type="text" id="full-name" name="full-name" required style="padding:0.6rem 1rem;border-radius:6px;border:1px solid #4f8cff;background:#181a1b;color:#f1f1f1;font-size:1rem;">
          </div>
      <div style="display:flex;flex-direction:column;gap:0.4rem;">
        <label for="email" style="color:#f1f1f1;font-size:1.05rem;">Email:</label>
        <input type="email" id="email" name="email" required style="padding:0.6rem 1rem;border-radius:6px;border:1px solid #4f8cff;background:#181a1b;color:#f1f1f1;font-size:1rem;">
          </div>
      <div style="display:flex;flex-direction:column;gap:0.4rem;">
        <label for="address" style="color:#f1f1f1;font-size:1.05rem;">Address:</label>
        <textarea id="address" name="address" required rows="2" style="padding:0.6rem 1rem;border-radius:6px;border:1px solid #4f8cff;background:#181a1b;color:#f1f1f1;font-size:1rem;"></textarea>
          </div>
      <button type="submit" id="submit-btn" style="margin-top:2.2rem;background:#4f8cff;color:#fff;border:none;border-radius:8px;padding:1rem 1.5rem;font-size:1.1rem;font-weight:600;cursor:pointer;transition:background 0.2s;">Pay</button>
        </form>
    <a href="index.html" class="back-btn">&#8592; Back to Shop</a>
    </div>
  <script>
    let cartItems = [];
    
    function getQueryParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }
    
    function formatOptions(options) {
      const formattedOptions = [];
      for (const [key, value] of Object.entries(options)) {
        if (key !== 'product' && key !== 'price' && key !== 'img' && key !== 'quantity') {
          const displayKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
          formattedOptions.push(`${displayKey}: ${value}`);
        }
      }
      return formattedOptions.join(', ');
    }
    
    function populateCartSummary() {
      const cartItemsSummary = document.getElementById('cart-items-summary');
      cartItemsSummary.innerHTML = '';
      
      if (cartItems.length === 0) {
        cartItemsSummary.innerHTML = '<p style="text-align:center;color:#f1f1f1;">No items in cart</p>';
        return;
      }
      
      cartItems.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'display:flex;align-items:center;gap:1rem;padding:1rem 0;border-bottom:1px solid #3a4048;';
        if (index === cartItems.length - 1) itemDiv.style.borderBottom = 'none';
        
        itemDiv.innerHTML = `
          <div style="flex:0 0 80px;">
            <img src="${item.img}" alt="${item.product}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;background:#181a1b;">
          </div>
          <div style="flex:1;color:#f1f1f1;">
            <div style="font-weight:600;color:#4f8cff;margin-bottom:0.3rem;">${item.product}</div>
            <div style="font-size:0.9rem;color:#b0b0b0;margin-bottom:0.5rem;">${formatOptions(item.options)}</div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <span style="color:#f1f1f1;">Qty: ${item.quantity}</span>
              <span style="color:#4f8cff;font-weight:600;">${item.price}</span>
            </div>
          </div>
        `;
        cartItemsSummary.appendChild(itemDiv);
      });
    }
    
    function updateTotals() {
      let subtotal = 0;
      
      cartItems.forEach(item => {
        const priceStr = item.price.replace('€ ', '').replace(',', '.');
        const price = parseFloat(priceStr);
        subtotal += price * item.quantity;
      });
      
      const shipping = 0; // Free shipping for all orders
      const total = subtotal + shipping;
      
      document.getElementById('checkout-subtotal').textContent = `€ ${subtotal.toFixed(2).replace('.', ',')}`;
      document.getElementById('checkout-shipping').textContent = 'Free';
      document.getElementById('checkout-total-price').textContent = `€ ${total.toFixed(2).replace('.', ',')}`;
    }
    
    // Initialize cart from URL parameters or localStorage
    function initializeCart() {
      const cartParam = getQueryParam('cart');
      if (cartParam) {
        try {
          // Decode the URL-encoded cart data and parse JSON
          const decodedCart = decodeURIComponent(cartParam);
          cartItems = JSON.parse(decodedCart);
          console.log('Cart items loaded from URL:', cartItems);
        } catch (e) {
          console.error('Error parsing cart data from URL:', e);
          // Fallback: try to get from localStorage
          const cart = localStorage.getItem('shoppingCart');
          cartItems = cart ? JSON.parse(cart) : [];
          console.log('Fallback to localStorage cart:', cartItems);
        }
      } else {
        // Fallback: try to get from localStorage
        const cart = localStorage.getItem('shoppingCart');
        cartItems = cart ? JSON.parse(cart) : [];
        console.log('Cart items loaded from localStorage:', cartItems);
      }
      
      populateCartSummary();
      updateTotals();
    }
    
    // Initialize on page load
    initializeCart();
  </script>
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS with your public key
    emailjs.init('y7LqCrsi8J-atkUez');
  </script>
  <script>
    const checkoutForm = document.getElementById('checkout-form');
    const submitBtn = document.getElementById('submit-btn');
    checkoutForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Redirecting...';
      
      // Gather form info
      const email = document.getElementById('email').value;
      const address = document.getElementById('address').value;
      const fullName = document.getElementById('full-name').value;
      const totalPrice = document.getElementById('checkout-total-price').textContent;
      
      // Create clean, formatted order summary for email
      let orderSummary = '';
      
      // Build the complete order summary with all products
      cartItems.forEach((item, index) => {
        const productNum = index + 1;
        orderSummary += `Product ${productNum}:\n`;
        orderSummary += `Name: ${item.product}\n`;
        orderSummary += `Quantity: ${item.quantity}\n`;
        orderSummary += `Price: ${item.price}\n`;
        
        // Add all available options for this product
        if (item.options.color) orderSummary += `Color: ${item.options.color}\n`;
        if (item.options.textColor) orderSummary += `Text Color: ${item.options.textColor}\n`;
        if (item.options.baseColor) orderSummary += `Base Color: ${item.options.baseColor}\n`;
        if (item.options.outerColor) orderSummary += `Outer Color: ${item.options.outerColor}\n`;
        if (item.options.innerColor) orderSummary += `Inner Color: ${item.options.innerColor}\n`;
        if (item.options.boxColor) orderSummary += `Box Color: ${item.options.boxColor}\n`;
        if (item.options.fingerColor) orderSummary += `Finger Color: ${item.options.fingerColor}\n`;
        if (item.options.batteryType) orderSummary += `Battery Type: ${item.options.batteryType}\n`;
        if (item.options.spotify) orderSummary += `Spotify: ${item.options.spotify}\n`;
        if (item.options.shape) orderSummary += `Shape: ${item.options.shape}\n`;
        if (item.options.size) orderSummary += `Size: ${item.options.size}\n`;
        if (item.options.name) orderSummary += `Name: ${item.options.name}\n`;
        if (item.options.guitarType) orderSummary += `Guitar Type: ${item.options.guitarType}\n`;
        orderSummary += `\n`;
      });
      
      // Add customer details and total at the end
      orderSummary += `Customer Details:\n`;
      orderSummary += `Name: ${fullName}\n`;
      orderSummary += `Address: ${address}\n`;
      orderSummary += `Email: ${email}\n`;
      orderSummary += `Total Amount Paid: ${totalPrice}\n`;
      
      // Calculate total quantity of all items
      const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
      
      // Simple email data with just the essential variables
      let emailData = {
        // Customer info
        customerName: fullName,
        customerAddress: address,
        customerEmail: email,
        totalAmount: totalPrice,
        itemCount: cartItems.length, // Number of different products
        totalItems: totalItems, // Total quantity of all items
        
        // Complete formatted order
        orderSummary: orderSummary,
        
        // For backward compatibility - first product details
        product: cartItems.length > 0 ? cartItems[0].product : 'Multiple Items',
        price: cartItems.length > 0 ? cartItems[0].price : totalPrice,
        quantity: totalItems
      };
      
      // Send order email via EmailJS with all product details
      try {
        await emailjs.send('service_we3cm9f', 'template_bubq4ev', emailData);
      } catch (err) {
        alert('Order email could not be sent, but you will still be redirected to payment.');
      }
      
      // Send to backend
      try {
        const response = await fetch('https://threed-print-shop-xhew.onrender.com/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cartItems,
            totalPrice,
            email,
            address,
            fullName
          })
        });
        const data = await response.json();
        if (data.url) {
          // Clear cart after successful order
          localStorage.removeItem('shoppingCart');
          window.location.href = data.url;
        } else {
          alert('Error: ' + (data.error || 'Could not create Stripe session.'));
          submitBtn.disabled = false;
          submitBtn.textContent = 'Pay';
        }
      } catch (err) {
        alert('Network error: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Pay';
      }
    });
  </script>
</body>
</html> 
